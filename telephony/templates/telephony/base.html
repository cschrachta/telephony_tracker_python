<!DOCTYPE html>
{% load static %}
{% load custom_filters %}
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}Telephony Tracker{% endblock %}</title>

  <!-- Custom styles -->
  <link rel="stylesheet" type="text/css" href="{% static 'styles/styles.css' %}">

  <!-- Bootstrap CSS (single version) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">

  <!-- DataTables CSS -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">

  {% block extra_css %}
  {% endblock %}

  <!-- jQuery -->
  <script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- DataTables JS -->
  <script type="text/javascript" charset="utf8"
    src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>

  <!-- Bootstrap JS (single version) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.11.6/umd/popper.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.1.3/js/bootstrap.min.js"></script>

  {% block extra_js %}
  {% endblock %}

</head>

<body>
  <header>
    <h1>Telephony Tracker</h1>
    {% include 'telephony/_navbar.html' %}
  </header>
  <main>
    <div class="container-fluid">
      <div class="d-flex">
        <div class="p-2 w-100">
          {% block content %}
          {% endblock %}
        </div>
      </div>
    </div>
  </main>


  {% block form %}
  <div class="container-fluid mb-5">
    {% if show_form %}
    <form method="post"
      action="{% if form.instance.pk %}{% url edit_url form.instance.pk %}{% else %}{% url new_url %}{% endif %}" class="{{ form_class }}">
      {% csrf_token %}
      {% block form_content %}
      {{ form.as_p }}
      {% endblock %}
      <div class="row mt-5">
        <div class="col-md-12">
          <button type="submit" name="action" value="add" class="btn btn-primary" {% if form.instance.pk %}disabled{% endif %}>Add</button>
          <button type="submit" name="action" value="update" class="btn btn-primary" {% if not form.instance.pk %}disabled{% endif %}>Update</button>
          <button type="button" class="btn btn-secondary" id="clear-form">Clear</button>
        </div>
      </div>
    </form>
    {% endif %}
  </div>
  {% endblock %}

  {% block table %}
  {% if show_table %}
  <div class="container-fluid">
    <table class="{{ table_class }} table table-hover">
      <thead>
        <tr>
          {% for column in table_headers %}
          <th>{{ column }}</th>
          {% endfor %}
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for item in items %}
        {% if item.id %}
        <tr data-id="{{ item.id }}">
          {% for field in table_fields %}
          <td>{{ item|get_attr:field }}</td>
          {% endfor %}
          <td>
            <a href="{% url edit_url item.id %}" class="btn btn-sm btn-primary">Edit</a>
            <form method="post" action="{% url delete_url item.id %}" style="display:inline;">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm btn-danger"
                onclick="return confirm('Are you sure you want to delete this entry?');">Delete</button>
            </form>
          </td>
        </tr>
        {% endif %}
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
  {% endblock %}
  <footer>
    <p>&copy; 2024 Telephony Tracker</p>
  </footer>
</body>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Initialize DataTable
    $('.{{ table_class }}').DataTable({
      "paging": true,
      "searching": true,
      "ordering": true,
      "info": true,
      "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
      "pageLength": 25,
      "colReorder": true,
      "colResize": true,
    });


    // Add event listener for the Clear button
    document.getElementById('clear-form').addEventListener('click', function () {
      // console.log('Clear button clicked');
      // Clear all input fields within the form
      document.querySelectorAll('input[type="text"], input[type="email"], input[type="url"], textarea').forEach(function (input) {
        input.value = '';
      });

      // Clear all select fields within the form
      document.querySelectorAll('select').forEach(function (select) {
        select.selectedIndex = 0;
      });

      // Reset the URL to base /service_provider/ without the trailing ID
      window.history.pushState({}, document.title, '/telephony/{{ clear_view_url }}/');
    });

    // Add click event listener for table rows
    document.querySelectorAll('.{{ table_class }} tr[data-id]').forEach(function (row) {
      row.addEventListener('click', function () {
        var id = row.getAttribute('data-id');
        fetch('/telephony/{{ clear_view_url }}/' + id + '/')
          .then(response => response.json())
          .then(data => {
            // Create fields from form fields dynamically
            {% for field in form_fields %}
            document.getElementById('id_{{ field }}').value = data.{{ field }};
            {% endfor %}
          });
      });
    });

    // Function to get CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          // Does this cookie string begin with the name we want?
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Add click event listener for delete buttons
    document.querySelectorAll('.delete-btn').forEach(function (button) {
      button.addEventListener('click', function (event) {
        event.stopPropagation();
        var id = button.getAttribute('data-id');
        if (confirm('Are you sure you want to delete?')) {
          fetch(`/delete_{{ clear_view_url }}/${id}/`, {
            method: 'DELETE',
            headers: {
              'X-CSRFToken': csrftoken
            }
          })
            .then(response => {
              if (response.ok) {
                // Remove the row from the table
                button.closest('tr').remove();
              } else {
                response.json().then(data => {
                  alert('Failed to delete: ' + data.error);
                }).catch(error => {
                  alert('Delete operation failed. Please try again.');
                });
              }
            })
            .catch(error => {
              alert('Delete operation failed. Please try again.');
            });
        }
      });
    });

  });
</script>


</html>

