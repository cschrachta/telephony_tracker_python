
{% extends 'telephony/base.html' %}

{% block content %}
<h2>Locations</h2>
<h4>Add/Update Location</h4>
<form method="post" action="" class="location-form">
  {% csrf_token %}
  <div class="mb-3">
    <label for="id_address" class="form-label">Address</label>
    <input type="text" class="form-control" id="id_address" name="address">
  </div>
  {{ form.as_p }}
  <button type="submit" class="btn btn-primary">Save</button>
</form>
<table class="location-table">
  <tr class="location-th location-td">
    <th>Name</th>
    <th>Display Name</th>
    <th>Location Address</th>
    <th>Notes</th>
    <th>Verified</th>
    <th>Actions</th>
  </tr>
  {% for location in locations %}
  <tr data-id="{{ location.id }}">
    <td>{{ location.name }}</td>
    <td>{{ location.display_name }}</td>
    <td>
      {% if location.house_number %}{{ location.house_number }} {% endif %}
      {% if location.road %}{{ location.road }}{% endif %}
      {% if location.road_suffix %}{{ location.road_suffix }}{% endif %}
      {% if location.city %}{{ location.city }}{% endif %}
      {% if location.state_abbreviation %}{{ location.state_abbreviation }}{% endif %}
      {% if location.postcode %}{{ location.postcode }}{% endif %}
    </td>
    <td>{{ location.notes }}</td>
    <td class="verified">
      {% if location.verified_location %}
      True
      {% else %}
      <button class="verify-btn" data-id="{{ location.id }}">Verify</button>
      {% endif %}
    </td>
    <td class="actions">
      <button class="delete-btn" data-id="{{ location.id }}">Delete</button>
    </td>
  </tr>
  {% endfor %}
</table>
{% endblock %}

{% block extra_js %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&libraries=places"></script>
<script>
  function initAutocomplete() {
    var input = document.getElementById('id_address');
    var autocomplete = new google.maps.places.Autocomplete(input);
    autocomplete.addListener('place_changed', function () {
      var place = autocomplete.getPlace();
      if (!place.geometry) {
        // User entered the name of a place that was not suggested
        return;
      }

      var addressComponents = place.address_components;
      var components = {
        street_number: 'short_name',
        route: 'long_name',
        locality: 'long_name',
        administrative_area_level_1: 'short_name',
        administrative_area_level_1_full: 'long_name',  // Full state name
        postal_code: 'short_name',
        country: 'long_name',
      };
      var address = {};
      for (var i = 0; i < addressComponents.length; i++) {
        var addressType = addressComponents[i].types[0];
        if (components[addressType]) {
          address[addressType] = addressComponents[i][components[addressType]];
        }
      }

      document.getElementById('id_house_number').value = address.street_number || '';
      document.getElementById('id_road').value = address.route || '';
      document.getElementById('id_city').value = address.locality || '';
      document.getElementById('id_state_abbreviation').value = address.administrative_area_level_1 || '';
      document.getElementById('id_postcode').value = address.postal_code || '';
      document.getElementById('id_country').value = address.country || '';
    });
  }

  document.addEventListener('DOMContentLoaded', function () {
    initAutocomplete();

    document.querySelectorAll('.location-table tr[data-id]').forEach(function (row) {
      row.addEventListener('click', function () {
        var id = row.getAttribute('data-id');
        fetch(`/locations/${id}/`).then(response => response.json()).then(data => {
          document.getElementById('id_name').value = data.name;
          document.getElementById('id_display_name').value = data.display_name;
          document.getElementById('id_house_number').value = data.house_number;
          document.getElementById('id_road').value = data.road;
          document.getElementById('id_road_suffix').value = data.road_suffix;
          document.getElementById('id_city').value = data.city;
          document.getElementById('id_state_abbreviation').value = data.state_abbreviation;
          document.getElementById('id_state').value = data.state;  // Full state name
          document.getElementById('id_postcode').value = data.postcode;
          document.getElementById('id_country').value = data.country;
          document.getElementById('id_notes').value = data.notes;
        });
      });
    });

    document.querySelectorAll('.verify-btn').forEach(function (button) {
      button.addEventListener('click', function (event) {
        event.stopPropagation();
        var id = button.getAttribute('data-id');
        fetch(`/verify_location/${id}/`).then(response => response.json()).then(data => {
          if (data.success) {
            button.closest('td').innerText = 'True';
          } else {
            alert('Address verification failed.');
          }
        });
      });
    });

    document.querySelectorAll('.delete-btn').forEach(function(button) {
      button.addEventListener('click', function (event) {
        event.stopPropagation();
        if (!confirm('Are you sure you want to delete this location?')) {
          return;
        }
        var id = button.getAttribute('data-id');
        fetch(`/delete_location/${id}/`, { method: 'DELETE' }).then(response => {
          if (response.ok) {
            button.closest('tr').remove();
          } else {
            alert('Failed to delete the location.');
          }
        });
      });
    });
  });

  document.querySelectorAll('.verify-btn')
  
</script>
{% endblock %}