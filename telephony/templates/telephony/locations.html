
{% extends 'telephony/base.html' %}

{% block content %}
<h2>Locations</h2>
<h4>Add/Update Location</h4>
<form method="post" action="" class="location-form">
  {% csrf_token %}
  {{ form.as_p }}
  <button type="submit" class="btn btn-primary">Save</button>
</form>
<table class="location-table">
  <tr class="location-th location-td">
    <th>Name</th>
    <th>Display Name</th>
    <th>Location Address</th>
    <th>Notes</th>
    <th>Verified</th>
    <th>Actions</th>
  </tr>
  {% for location in locations %}
  <tr data-id="{{ location.id }}">
    <td>{% if location.name %}{{ location.name }}{% endif %}</td>
    <td>{% if location.display_name %}{{ location.display_name }}{% endif %}</td>
    <td>
      {% if location.house_number %}{{ location.house_number }} {% endif %}
      {% if location.road %}{{ location.road }}{% endif %}
      {% if location.road_suffix %}{{ location.road_suffix }}{% endif %}
      {% if location.city %}{{ location.city }}{% endif %}
      {% if location.state_abbreviation %}{{ location.state_abbreviation }}{% endif %}
      {% if location.postcode %}{{ location.postcode }}{% endif %}
      {% if location.country %}{{ location.country }}{% endif %}
    </td>
    <td>{{ location.notes }}</td>
    <td class="verified">{{ location.verified_location }}</td>
    <td class="actions">
      {% if not location.verified_location %}
      <button onclick="location.href='{% url 'verify_location' location.id %}'">Verify Address</button>
      {% endif %}
      <form method="post" action="{% url 'delete_location' location.id %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" onclick="return confirm('Are you sure you want to delete this location?');">Delete</button>
      </form>
    </td>
  </tr>
  {% endfor %}
</table>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.location-table tr[data-id]').forEach(function (row) {
      row.addEventListener('click', function () {
        var id = row.getAttribute('data-id');
        fetch(`/locations/${id}/`).then(response => response.json()).then(data => {
          document.getElementById('id_name').value = data.name;
          document.getElementById('id_display_name').value = data.display_name;
          document.getElementById('id_house_number').value = data.house_number;
          document.getElementById('id_road').value = data.road;
          document.getElementById('id_road_suffix').value = data.road_suffix;
          document.getElementById('id_city').value = data.city;
          document.getElementById('id_state_abbreviation').value = data.state_abbreviation;
          document.getElementById('id_state').value = data.state;  // Full state name
          document.getElementById('id_postcode').value = data.postcode;
          document.getElementById('id_country').value = data.country;
          document.getElementById('id_notes').value = data.notes;
        });
      });
    });

    document.querySelectorAll('.verify-btn').forEach(function (button) {
      button.addEventListener('click', function (event) {
        event.stopPropagation();
        var id = button.getAttribute('data-id');
        fetch(`/verify_location/${id}/`).then(response => response.json()).then(data => {
          if (data.success) {
            button.closest('td').innerText = 'True';
          } else {
            alert('Address verification failed.');
          }
        });
      });
    });

    document.querySelectorAll('.delete-btn').forEach(function (button) {
      button.addEventListener('click', function (event) {
        event.stopPropagation();
        if (!confirm('Are you sure you want to delete this location?')) {
          return;
        }
        var id = button.getAttribute('data-id');
        fetch(`/delete_location/${id}/`, { method: 'DELETE' }).then(response => {
          if (response.ok) {
            button.closest('tr').remove();
          } else {
            alert('Failed to delete the location.');
          }
        });
      });
    });
  });
</script>
{% endblock %}